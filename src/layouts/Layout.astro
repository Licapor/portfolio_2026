---
import { getLangFromUrl, useTranslations } from '../i18n/utils';

interface Props {
  title: string;
  description?: string;
}

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
const canonicalURL = new URL(Astro.url.pathname, Astro.site || 'https://iele.dev');

const {
  title,
  description = lang === 'es'
    ? "Estudio de desarrollo de productos digitales. Creando experiencias digitales modernas y funcionales."
    : "Digital product development studio. Creating modern and functional digital experiences."
} = Astro.props;

// Alternate language URLs for hreflang
const currentPath = Astro.url.pathname;
const esURL = currentPath.startsWith('/en') ? currentPath.replace('/en', '') || '/' : currentPath;
const enURL = currentPath.startsWith('/en') ? currentPath : `/en${currentPath}`;

const ogImage = `${canonicalURL.origin}/og-image.png`;
---

<!doctype html>
<html lang={lang}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={description} />
    <meta name="author" content={t('global.name')} />
    <meta name="robots" content="index, follow" />
    <link rel="canonical" href={canonicalURL.href} />

    <!-- Hreflang for i18n SEO -->
    <link rel="alternate" hreflang="es" href={`${canonicalURL.origin}${esURL}`} />
    <link rel="alternate" hreflang="en" href={`${canonicalURL.origin}${enURL}`} />
    <link rel="alternate" hreflang="x-default" href={`${canonicalURL.origin}${esURL}`} />

    <!-- Open Graph -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content={canonicalURL.href} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={ogImage} />
    <meta property="og:locale" content={lang === 'es' ? 'es_MX' : 'en_US'} />

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={ogImage} />

    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet" />

    <slot name="head" />

    <title>{title}</title>

    <!-- JSON-LD Structured Data -->
    <script type="application/ld+json" set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "Person",
      "name": t('global.name'),
      "url": canonicalURL.origin,
      "email": t('global.email'),
      "jobTitle": "Digital Product Developer",
      "knowsAbout": ["Product Development", "Frontend", "No-Code", "AdTech"],
      "address": {
        "@type": "PostalAddress",
        "addressLocality": t('about.location')
      }
    })} />

    <style is:global>
      @import "../styles/global.css";

      body {
        font-family: 'Inter', system-ui, sans-serif;
        background-color: #fafafa;
        color: #1f2937;
        min-height: 100vh;
        overflow-x: hidden;
      }

      h1, h2, h3, h4, h5, h6 {
        font-family: 'Space Grotesk', sans-serif;
      }
    </style>
  </head>
  <body class="antialiased">
    <slot />

    <script>
      // Scroll Reveal
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            entry.target.classList.add('visible');
          }
        });
      }, { threshold: 0.1 });

      document.querySelectorAll('.reveal, .reveal-left, .reveal-right, .reveal-scale').forEach(el => {
        observer.observe(el);
      });

      // Split text animation
      document.querySelectorAll('.split-text').forEach(el => {
        const text = el.textContent || '';
        el.innerHTML = text.split('').map((char, i) =>
          `<span style="animation-delay: ${i * 0.03}s">${char === ' ' ? '&nbsp;' : char}</span>`
        ).join('');
      });

      // Parallax effect for geometric shapes
      document.addEventListener('mousemove', (e) => {
        const shapes = document.querySelectorAll('.geo-parallax');
        const x = (e.clientX / window.innerWidth - 0.5) * 20;
        const y = (e.clientY / window.innerHeight - 0.5) * 20;

        shapes.forEach((shape, i) => {
          const el = shape as HTMLElement | SVGElement;
          const factor = (i + 1) * 0.5;
          el.style.transform = `translate(${x * factor}px, ${y * factor}px)`;
        });
      });

      // Header scroll
      const header = document.querySelector('header');
      window.addEventListener('scroll', () => {
        if (header) {
          header.classList.toggle('scrolled', window.pageYOffset > 50);
        }
      });
    </script>
  </body>
</html>
